generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id               String              @id @default(uuid())
  name             String
  slug             String              @unique
  creditsBalance   Int                 @default(0)
  publicHourlyRate Float               @default(0)
  monthlyQuota     Int                 @default(1000)
  aiSettings       String?
  logoUrl          String?
  primaryColor     String?
  status           String              @default("ACTIVE")
  settings         Json?               // Health thresholds/config
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  auditLogs        AuditLog[]
  contracts        Contract[]
  transactions     CreditTransaction[]
  examSessions     ExamSession[]
  invitations      Invitation[]
  offlineProofs    OfflineProof[]
  questions        Question[]
  proposals        TrainingProposal[]
  users            User[]
  classrooms       Classroom[]
  courseSessions   CourseSession[]
}

model Classroom {
  id             String       @id @default(uuid())
  name           String
  level          String?      // A1, A2...
  program        String?      // STANDARD, INTENSIVE
  capacity       Int          @default(15)
  organizationId String
  coachId        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  coach          User?        @relation("CoachClassrooms", fields: [coachId], references: [id])
  students        User[]         @relation("StudentClassroom")
  courseSessions  CourseSession[]
}

model User {
  id                       String              @id @default(uuid())
  email                    String              @unique
  password                 String
  name                     String?
  role                     String              @default("CANDIDATE")
  currentLevel             String              @default("A1")
  targetLevel              String?             @default("B2")
  hasCompletedDiagnostic   Boolean             @default(false)
  organizationId           String?
  xp                       Int                 @default(0)
  streakCurrent            Int                 @default(0)
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  salesRepId               String?
  coachId                  String?
  classroomId              String?
  objective                String?
  address                  String?
  city                     String?
  contactPerson            String?
  hourlyRate               Float?
  nda                      String?
  phone                    String?
  postalCode               String?
  tags                     String?
  signature                String?
  hasVerifiedPrerequisites Boolean             @default(false)
  prerequisitesProofUrl    String?
  lastActivityDate         DateTime?
  streakMax                Int                 @default(0)
  auditLogs                AuditLog[]
  availabilities           CoachAvailability[]
  invoices                 CoachInvoice[]
  contracts                Contract[]
  examSessions             ExamSession[]
  formateurDocuments       FormateurDocument[]
  notifications            Notification[]
  offlineProofs            OfflineProof[]
  coachActions             PedagogicalAction[] @relation("CoachActions")
  pedagogicalActions       PedagogicalAction[] @relation("StudentActions")
  proposals                TrainingProposal[]
  coach                    User?               @relation("CoachStudents", fields: [coachId], references: [id])
  students                 User[]              @relation("CoachStudents")
  organization             Organization?       @relation(fields: [organizationId], references: [id])
  salesRep                 User?               @relation("SalesCandidates", fields: [salesRepId], references: [id])
  candidates               User[]              @relation("SalesCandidates")
  badges                   UserBadge[]
  civicProgress            UserCivicProgress[]
  classroom                Classroom?          @relation("StudentClassroom", fields: [classroomId], references: [id])
  coachedClassrooms        Classroom[]         @relation("CoachClassrooms")
  coachSessions            CourseSession[]     @relation("CoachSessions")
  attendances              Attendance[]        @relation("CandidateAttendances")
}

model CoachAvailability {
  id          String    @id @default(uuid())
  coachId     String
  dayOfWeek   Int
  startTime   String
  endTime     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  date        DateTime?
  isRecurring Boolean   @default(true)
  coach       User      @relation(fields: [coachId], references: [id])
}

model CoachInvoice {
  id             String   @id @default(uuid())
  invoiceNumber  String   @unique
  coachId        String
  organizationId String
  amount         Float
  hoursCount     Float
  status         String   @default("DRAFT")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  coach          User     @relation(fields: [coachId], references: [id])
}

model PedagogicalAction {
  id        String   @id @default(uuid())
  type      String
  content   String
  studentId String
  coachId   String
  createdAt DateTime @default(now())
  coach     User     @relation("CoachActions", fields: [coachId], references: [id])
  student   User     @relation("StudentActions", fields: [studentId], references: [id])
}

model FormateurDocument {
  id        String   @id @default(uuid())
  userId    String
  type      String
  filename  String
  url       String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model TrainingProposal {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  baseLevel      String
  targetLevel    String
  estimatedHours Int
  hourlyRate     Float
  totalCost      Float
  planModules    String
  status         String       @default("DRAFT")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
}

model Contract {
  id                  String       @id @default(uuid())
  startDate           DateTime
  endDate             DateTime?
  hourlyRate          Float        @default(0)
  totalHours          Int          @default(0)
  status              String       @default("ACTIVE")
  contractDocumentUrl String?       // Link to signed PDF contract
  formateurId         String
  organizationId      String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  formateur           User         @relation(fields: [formateurId], references: [id])
  organization        Organization @relation(fields: [organizationId], references: [id])
}

model ExamSession {
  id                   String       @id @default(uuid())
  userId               String
  organizationId       String
  type                 String       @default("EXAM")
  status               String       @default("PENDING")
  score                Int?
  estimatedLevel       String?
  scoreHash            String?      @unique
  integrityScore       Int          @default(0)
  integrityStatus      String?      @default("VALID")
  aiTokensUsed         Int          @default(0)
  aiCostUsd            Float        @default(0)
  humanGrade           Int?
  correlationScore     Float?
  aiDebugData          Json?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  breakdown            String?
  completedAt          DateTime?
  currentQuestionIndex Int?         @default(0)
  startedAt            DateTime?
  durationMinutes      Int          @default(60)
  feedback             String?
  responses            String?
  organization         Organization @relation(fields: [organizationId], references: [id])
  user                 User         @relation(fields: [userId], references: [id])
  answers              UserAnswer[]
}

model UserAnswer {
  id             String      @id @default(uuid())
  sessionId      String
  questionId     String
  isCorrect      Boolean
  selectedOption String?
  createdAt      DateTime    @default(now())
  question       Question    @relation(fields: [questionId], references: [id])
  session        ExamSession @relation(fields: [sessionId], references: [id])
}

model CreditTransaction {
  id             String       @id @default(uuid())
  organizationId String
  amount         Int
  type           String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Question {
  id             String       @id @default(uuid())
  organizationId String
  level          String
  topic          String
  skill          String       @default("READING")
  content        String
  questionText   String
  options        String
  correctAnswer  String
  explanation    String
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  answers        UserAnswer[]
}

model Invitation {
  id             String       @id @default(uuid())
  email          String
  token          String       @unique
  organizationId String
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model OfflineProof {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  title          String
  type           String
  description    String?
  proofUrl       String?
  status         String       @default("PENDING")
  xpAwarded      Int          @default(0)
  feedback       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
}

model AuditLog {
  id             String        @id @default(uuid())
  action         String
  entityType     String
  entityId       String
  payload        String?
  userId         String?
  organizationId String?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
}

model Lead {
  id          String   @id @default(uuid())
  email       String
  schoolName  String
  contactName String?
  phone       String?
  status      String   @default("NEW")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  content   String
  type      String   @default("info")
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Message {
  id          String   @id @default(uuid())
  senderId    String
  recipientId String
  content     String
  type        String   @default("text")
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Badge {
  id          String      @id @default(uuid())
  name        String
  description String
  icon        String
  color       String
  rarity      String      @default("COMMON")
  users       UserBadge[]
}

model UserBadge {
  id         String   @id @default(uuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())
  badge      Badge    @relation(fields: [badgeId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
}

model CivicModule {
  id        String          @id @default(uuid())
  title     String
  topic     String
  order     Int             @default(0)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  lessons   CivicLesson[]
  questions CivicQuestion[]
}

model CivicLesson {
  id        String      @id @default(uuid())
  moduleId  String
  title     String
  content   String
  videoId   String?
  keyPoints String?
  order     Int         @default(0)
  module    CivicModule @relation(fields: [moduleId], references: [id])
}

model CivicQuestion {
  id            String       @id @default(uuid())
  moduleId      String?
  text          String
  options       String
  correctAnswer Int
  explanation   String?
  isOfficial    Boolean      @default(false)
  category      String?
  createdAt     DateTime     @default(now())
  module        CivicModule? @relation(fields: [moduleId], references: [id])
}

model UserCivicProgress {
  id        String   @id @default(uuid())
  userId    String
  moduleId  String
  lessonId  String?
  status    String   @default("COMPLETED")
  score     Int?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, moduleId, lessonId])
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, boolean, number
  updatedAt DateTime @updatedAt
}

model Topic {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Sector {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model CourseSession {
  id              String       @id @default(uuid())
  coachId         String
  classroomId     String?
  organizationId  String
  title           String
  description     String?
  scheduledDate   DateTime
  startTime       String       // "09:00"
  endTime         String       // "11:00"
  durationMinutes Int          // Calculated or set: 120
  status          String       @default("SCHEDULED") // SCHEDULED, OPEN, COMPLETED, CANCELLED
  type            String       @default("COURSE")    // COURSE, MOCK_EXAM
  recurrenceId    String?      // Optional: to group recurring sessions
  openedAt        DateTime?    // When coach started session
  closedAt        DateTime?    // When coach ended session
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  coach           User         @relation("CoachSessions", fields: [coachId], references: [id])
  classroom       Classroom?   @relation(fields: [classroomId], references: [id])
  organization    Organization @relation(fields: [organizationId], references: [id])
  attendances     Attendance[]
}

model Attendance {
  id            String        @id @default(uuid())
  sessionId     String
  candidateId   String
  signedAt      DateTime      @default(now())
  signatureData String?       // Optional: base64 signature or "PRESENT"

  session       CourseSession @relation(fields: [sessionId], references: [id])
  candidate     User          @relation("CandidateAttendances", fields: [candidateId], references: [id])

  @@unique([sessionId, candidateId])
}
